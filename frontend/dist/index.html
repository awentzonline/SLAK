<DOCTYPE html5>
<html>
<head>
    <link rel="stylesheet" href="//cdn.quilljs.com/0.16.0/quill.snow.css" />
</head>
<body>
    <div id="connection">Not connected</div>
    <!-- Create the toolbar container -->
    <div id="toolbar">
      <button class="ql-bold">Bold</button>
      <button class="ql-italic">Italic</button>
    </div>

    <!-- Create the editor container -->
    <div id="editor">
      <div>Hello World!</div>
    </div>

    <!-- Initialize Quill editor -->
    <script src="//cdn.quilljs.com/0.16.0/quill.min.js"></script>
    <script>
      var elConnected = document.getElementById('connection');
      var editor = new Quill('#editor');
      editor.addModule('toolbar', { container: '#toolbar' });
      var socket = new WebSocket('ws://' + document.location.host + '/ws/');
      var socketConnected = false;
      var me = Math.random();
      function onDelta(data) {
        if (data.who != me) {
          editor.updateContents(data.delta);
        }
      }
      socket.onopen = function () {
        console.log('connected');
        elConnected.innerHTML = 'Connected';
        socketConnected = true;
      };
      socket.onmessage = function (msg) {
        var data = JSON.parse(msg.data);
        onDelta(data); 
      };
      socket.onerror = function () {
        elConnected.innerHTML = 'Error';
        socketConnected = false;
      };
      socket.onclose = function () {
        elConnected.innerHTML = 'Not connected';
        socketConnected = false;
      };
      editor.on('text-change', function (delta, source) {
        if (!socketConnected) {
          return;
        }
        if (source == 'user') {
          socket.send(JSON.stringify({
            who: me,
            delta: delta
          }));
        }
      });

    </script>
    
</body>
</html>